name: Deploy to Hams vms
on: 
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
     - name: Checkout repository
       uses: actions/checkout@v4

     - name: fix git permissions 
       run: chmod -R a+r .git/ || true

     - name: Copy project to remote vm
       uses: appleboy/scp-action@v0.1.5
       with:
          host: ${{ secrets.VMIP }}
          username: ubuntu
          key: ${{ secrets.SSH }}
          source: "."
          target: "/home/ubuntu/n8n-compose"
          overwrite: true  
     - name: creat .env file on ec2
       uses: appleboy/ssh-action@v1.0.3
       with:
          host: ${{secrets.VMIP }}
          username: ubuntu
          key: ${{ secrets.SSH }}
          script: | 
            APP_DIR="/home/ubuntu/n8n-compose"
            cd "$APP_DIR"
            cat > .env << 'ENV_EOF'
            DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}   
            SUBDOMAIN=${{secrets.SUBDOMAIN}}
            GENERIC_TIMEZONE=${{ secrets.GENERIC_TIMEZONE }}
            SSL_EMAIL=${{ secrets.SSL_EMAIL }}  
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}  
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}  
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}  
            POSTGRES_NON_ROOT_USER=${{ secrets.POSTGRES_NON_ROOT_USER }}  
            POSTGRES_NON_ROOT_PASSWORD=${{ secrets.POSTGRES_NON_ROOT_PASSWORD }}  
            ENV_EOF
            echo ".env file is created"
     - name: Deploy to Staging
       uses: appleboy/ssh-action@v1.0.3
       with:
          host: ${{ secrets.VMIP }}
          username: ubuntu
          key: ${{ secrets.SSH }}
          port: 22
          timeout: 600s
          command_timeout: 60m
          script_stop: true
          debug: true
          script: |
            set -e
            echo "=== Starting Smart Deployment ==="
            APP_DIR="/home/ubuntu/n8n-compose"
            cd "$APP_DIR"

            if [ ! -f ".env" ]; then
              echo "❌ .env file missing - CRITICAL ERROR"
              exit 1
            fi

            echo "✅ .env file verified"

            # Install Docker if missing
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              sudo usermod -aG docker ubuntu
              sudo systemctl enable docker
            fi
            sudo systemctl start docker
            sudo docker compose up -d